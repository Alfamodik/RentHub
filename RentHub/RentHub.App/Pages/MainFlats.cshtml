@page
@model RentHub.App.Pages.MainFlatsModel
@{
    Layout = null;
}
@functions {
    public string ConvertToImageSrcAsync(byte[]? blobData)
    {
        if (blobData == null || blobData.Length == 0)
            return "~/img/FlatPlaceholder.svg";
        
        string base64String = Convert.ToBase64String(blobData);
        return $"data:image/jpeg;base64,{base64String}";
    }
}

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>Квартиры</title>
    <link href="~/css/MainPage.css" rel="stylesheet"/>
</head>
<body>
    <div id="side-bar">
        <p id="main-text">Недвижимость</p>

        <form class="menu-item" method="get" action="/MainFlats">
            <img src="~/img/side-bar/House 1.svg" alt="404" />
            <button type="submit" name="FlatsBtn">Квартиры</button>
        </form>

        <form class="menu-item" method="get" action="/Reservations">
            <img src="~/img/side-bar/Calendar 1.svg" alt="404" />
            <button type="submit">Бронирования</button>
        </form>

        <form class="menu-item" method="get" action="/RentersList">
            <img src="~/img/side-bar/users 1.svg" alt="404" />
            <button type="submit" name="CustomersBtn">Жильцы</button>
        </form>

        <form class="menu-item" method="get" asp-page="/Reportcshtml">
            <img src="~/img/side-bar/chart-no-axes-column 1.svg" alt="404" />
            <button type="submit">Отчетность</button>
        </form>
    </div>

    <div id="main-content-main-page">
        <div class="top-bar">
            <form asp-page-handler="Logout" id="logoutForm">
                <a href="#" onclick="confirmLogout()">
                    <img src="~/img/logout.png" alt="Фотка иконки юзера" />
                </a>
            </form>
        </div>
        <div class="search-container">
            <div class="search-bar-container">
                <input id="searchFlatsInput" type="text" placeholder="Поиск по адресу..." />
            </div>
            <div class="filters-container">
                <select id="cityFilter">
                    <option value="">Все города</option>
                </select>
                <select id="roomsFilter">
                    <option value="">Кол-во комнат</option>
                </select>
            </div>
        </div>

        <div class="flats-card-container" id="flatsContainer">
            @if (Model.Flats != null && Model.Flats.Any())
            {
                @foreach (var flat in Model.Flats)
                {
                    <div class="flat-card"
                         data-address="@($"{flat.Country} {flat.City} {flat.District} {flat.HouseNumber} {flat.ApartmentNumber}")"
                         data-city="@flat.City"
                         data-rooms="@flat.RoomCount">

                        <form asp-page-handler="SaveChange" method="post" class="main-card-form">
                            <input type="hidden" name="flatId" value="@flat.FlatId" />
                            <div class="card-content" onclick="this.closest('form').submit()">
                                <img src="@ConvertToImageSrcAsync(flat.Photo)" alt="Фотка квартиры" />
                                <div class="flat-info-container">
                                    <p><span>Адрес:</span> @flat.City, ул.@flat.District, д.@flat.HouseNumber, кв.@flat.ApartmentNumber</p>
                                    <p><span>Комнат:</span> @flat.RoomCount</p>
                                    <p><span>Этаж:</span> @flat.FloorNumber/@flat.FloorsNumber</p>
                                    <p><span>Площадь:</span> @flat.Size м²</p>
                                </div>
                            </div>
                        </form>

                        <div class="delete-flat-container">
                            <form method="post" asp-page-handler="DeleteFlat" onsubmit="return confirm('Вы уверены, что хотите удалить эту квартиру?');">
                                <input type="hidden" name="FlatIdToDelete" value="@flat.FlatId" />
                                <button type="submit" class="delete-btn">🗑</button>
                            </form>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="no-flats">
                    <p>Квартиры не найдены</p>
                </div>
            }
            <button id="addFlatBtn" class="add-button">+</button>
        </div>

        <div id="noFlatsResults" class="no-flats" style="display: none;">
            <p>Квартиры не найдены</p>
        </div>
    </div>
    <div id="addFlatModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Добавить новую квартиру</h2>
            <form id="addFlatForm" method="post" enctype="multipart/form-data" asp-page-handler="AddFlat">
                <div class="form-group">
                    <input type="text" placeholder="Страна" asp-for="NewFlat.Country" id="country" name="country" maxlength="100" required>
                    <input type="text" placeholder="Город" asp-for="NewFlat.City" id="city" name="city" maxlength="100" required>
                    <input type="text" placeholder="Улица" asp-for="NewFlat.District" id="district" name="district" maxlength="100" required>
                </div>
                <div class="form-group">
                    <input type="text" placeholder="Номер дома" asp-for="NewFlat.HouseNumber" id="houseNumber" name="houseNumber" maxlength="10" required>
                </div>
                <div class="form-group">
                    <input type="text" placeholder="Номер квартиры" asp-for="NewFlat.ApartmentNumber" id="apartmentNumber" name="apartmentNumber" maxlength="5" required>
                </div>
                <div class="form-group">
                    <label for="roomCount">Кол-во комнат:</label>
                    <input type="number" asp-for="NewFlat.RoomCount" id="roomCount" name="roomCount" min="1" max="11" required>
                </div>
                <div class="form-group">
                    <label for="size">Площадь:</label>
                    <input type="number" asp-for="NewFlat.Size" id="size" name="size" min="5" max="1000" required>
                </div>
                <div class="form-group">
                    <label for="floorNumber">Этаж:</label>
                    <input type="number" asp-for="NewFlat.FloorNumber" id="floorNumber" name="floorNumber" min="1" max="163" required>
                </div>
                <div class="form-group">
                    <input type="number" placeholder="Кол-во этажей" asp-for="NewFlat.FloorsNumber" id="floorsNumber" name="floorsNumber" min="1" max="163">
                </div>
                <div class="form-group">
                    <textarea type="text" placeholder="Описание" asp-for="NewFlat.Description" id="description" name="description" required></textarea>
                </div>
                <div class="form-group photo-section">
                    <label>Фото квартиры:</label>
                    <input type="file" asp-for="PhotoUploadAdd" style="margin-top:10px; width:100%" />
                </div>
                <div class="form-buttons">
                    <button type="submit" class="submit-btn">Добавить</button>
                    <button type="button" class="cancel-btn">Отмена</button>
                </div>
            </form>
        </div>
    </div>
    <script>

        const modal = document.getElementById('addFlatModal');
        const addBtn = document.getElementById('addFlatBtn');
        const closeBtn = document.querySelector('.close');
        const cancelBtn = document.querySelector('.cancel-btn');
        const form = document.querySelector('#addFlatForm')

         addBtn.onclick = function () {
            modal.style.display = 'block';
         }

         closeBtn.onclick = function () {
            modal.style.display = 'none';
            form.reset();
         }

         cancelBtn.onclick = function () {
            modal.style.display = 'none';
            form.reset();
         }

         window.onclick = function (event) {
         if (event.target == modal) {
                modal.style.display = 'none';
                form.reset();
         }
        }

        function confirmLogout() {
            if (confirm('Вы уверены, что хотите выйти?')) {
                document.getElementById('logoutForm').submit();
            }
        }
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchFlatsInput');
            const cityFilter = document.getElementById('cityFilter');
            const roomsFilter = document.getElementById('roomsFilter');
            const flatsContainer = document.getElementById('flatsContainer');

            // Заполнение фильтров
            fillCityFilter();
            fillCountRoomsFilter();

            // События для поиска и фильтрации
            searchInput.addEventListener('input', applyFilters);
            cityFilter.addEventListener('change', applyFilters);
            roomsFilter.addEventListener('change', applyFilters);

            function fillCityFilter() {
                const cards = document.querySelectorAll('.flat-card');
                const cities = new Set();

                cards.forEach(card => {
                    const city = card.getAttribute('data-city');
                    if (city) cities.add(city);
                });

                cities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    cityFilter.appendChild(option);
                });
            }

            function fillCountRoomsFilter() {
                const cards = document.querySelectorAll('.flat-card');
                const roomGroups = new Map();

                cards.forEach(card => {
                    const room = parseInt(card.getAttribute('data-rooms'));
                    if (!isNaN(room)) {
                        let group = room.toString();
                        if (room >= 4) group = '4+';

                        roomGroups.set(group);
                    }
                });

                roomsFilter.innerHTML = '<option value="">Все комнаты</option>';

                [1, 2, 3].forEach(room => {
                    if (roomGroups.has(room.toString())) {
                        const option = document.createElement('option');
                        option.value = room.toString();
                        option.textContent = `${room} ${room == 1 ? 'комната' : 'комнаты'}`;
                        roomsFilter.appendChild(option);
                    }
                });

                if (roomGroups.has('4+')) {
                    const option = document.createElement('option');
                    option.value = '4+';
                    option.textContent = `4+ комнаты`;
                    roomsFilter.appendChild(option);
                }
            }

            function applyFilters() {
                const searchTerm = searchInput.value.toLowerCase().trim();
                const selectedCity = cityFilter.value;
                const selectedRooms = roomsFilter.value;
                const cards = document.querySelectorAll('.flat-card');
                const noResults = document.getElementById('noFlatsResults');
                let visibleCount = 0;

                cards.forEach(card => {
                    const address = card.getAttribute('data-address').toLowerCase();
                    const city = card.getAttribute('data-city');
                    const rooms = card.getAttribute('data-rooms');

                    let matchesSearch = true;
                    let matchesCity = true;
                    let matchesRooms = true;

                    // Проверка поиска по адресу
                    if (searchTerm != '' && !address.includes(searchTerm)) {
                        matchesSearch = false;
                    }

                    // Проверка фильтра города
                    if (selectedCity != '' && city != selectedCity) {
                        matchesCity = false;
                    }

                    // Проверка фильтра комнат
                    if (selectedRooms != '') {
                        const room = parseInt(rooms);

                        if (selectedRooms == '4+') {
                            if (room < 4) matchesRooms = false;
                        } else {
                            if (rooms != selectedRooms) matchesRooms = false;
                        }
                    }

                    if (matchesSearch && matchesCity && matchesRooms) {
                        card.style.display = 'block';
                        visibleCount++;
                    } else {
                        card.style.display = 'none';
                    }
                });

                // не найдено
                if (visibleCount == 0) {
                    noResults.style.display = 'block';
                    flatsContainer.style.display = 'none';
                } else {
                    noResults.style.display = 'none';
                    flatsContainer.style.display = 'grid';
                }
            }

        });
    </script>
</body>
</html>
