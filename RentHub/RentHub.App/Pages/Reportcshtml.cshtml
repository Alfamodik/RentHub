@page
@model RentHub.App.Pages.ReportcshtmlModel
@{
    Layout = null;
}

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>Отчетность</title>
    <link href="~/css/report.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div id="side-bar">
        <p id="main-text">Недвижимость</p>

        <form class="menu-item" method="get" action="/MainFlats">
            <img src="~/img/side-bar/House 1.svg" alt="404" />
            <button type="submit" name="FlatsBtn">Квартиры</button>
        </form>

        <form class="menu-item" method="get" action="/Reservations">
            <img src="~/img/side-bar/Calendar 1.svg" alt="404" />
            <button type="submit">Бронирования</button>
        </form>

        <form class="menu-item" method="get" action="/RentersList">
            <img src="~/img/side-bar/users 1.svg" alt="404" />
            <button type="submit" name="CustomersBtn">Жильцы</button>
        </form>

        <form class="menu-item" method="get" asp-page="/Reportcshtml">
            <img src="~/img/side-bar/chart-no-axes-column 1.svg" alt="404" />
            <button type="submit">Отчетность</button>
        </form>
    </div>

    <div class="main-cont">
        <div class="filter-bar">
            <label for="apartmentSelect">Фильтр по квартирам:</label>
            <select id="apartmentSelect" class="form-select">
                <option value="">Все квартиры</option>
                @foreach (var flat in Model.Flats)
                {
                    <option value="@flat.FlatId" selected="@(Request.Query["flatId"] == flat.FlatId.ToString())">
                        @($"{flat.City}, {flat.District}, д.{flat.HouseNumber}, кв.{flat.ApartmentNumber}")
                    </option>
                }
            </select>
        </div>

        <div class="charts-container">
            <div class="chart-box">
                <h3>Количество броней по месяцам</h3>
                <canvas id="bookingsChart"></canvas>
            </div>

            <div class="chart-box">
                <h3>Процент заполняемости</h3>
                <canvas id="occupancyChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        const bookingsData = @Html.Raw(Json.Serialize(Model.BookingsByMonth));
        const occupancyData = @Html.Raw(Json.Serialize(Model.OccupancyData));

        let bookingsChart, occupancyChart;

        function renderCharts() {
            const labels = bookingsData.map(item => item.label);
            const values = bookingsData.map(item => item.value);
            const occupancyValues = occupancyData.map(item => item.value);

            if (bookingsChart) bookingsChart.destroy();
            if (occupancyChart) occupancyChart.destroy();

            // График броней
            const ctx1 = document.getElementById('bookingsChart').getContext('2d');
            bookingsChart = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Брони',
                        data: values,
                        backgroundColor: '#38bdf8'
                    }]
                }
            });

            // График заполняемости
            const ctx2 = document.getElementById('occupancyChart').getContext('2d');
            occupancyChart = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Заполняемость (%)',
                        data: occupancyValues,
                        borderColor: '#fbbf24',
                        backgroundColor: 'rgba(251,191,36,0.3)',
                        fill: true
                    }]
                }
            });
        }

        renderCharts();

        document.getElementById('apartmentSelect').addEventListener('change', function (e) {
            const flatId = e.target.value;
            const newUrl = `/Reportcshtml?flatId=${flatId}`;
            window.location.href = newUrl;
        });
    </script>
</body>
</html>