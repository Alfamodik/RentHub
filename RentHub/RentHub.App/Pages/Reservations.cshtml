@page
@using RentHub.App.ViewModels
@using RentHub.Core.Model
@model RentHub.App.Pages.ReservationsModel
@{
    Layout = null;
    var cols = "150px " + string.Join(" ", Enumerable.Repeat("60px", Model.DaysCount));
}

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>Бронирования</title>
    <link href="~/css/MainPage.css" rel="stylesheet" />
    <link href="~/css/Reservations.css" rel="stylesheet" />
</head>
<body>

    <div id="side-bar">
        <p id="main-text">Недвижимость</p>

        <form class="menu-item" method="get" action="/MainFlats">
            <img src="~/img/side-bar/House 1.svg" alt="/MainFlats" />
            <button type="submit" name="FlatsBtn">Квартиры</button>
        </form>

        <form class="menu-item" method="get" action="/Reservations">
            <img src="~/img/side-bar/Calendar 1.svg" alt="404" />
            <button type="submit" name="ReservationsBtn">Бронирования</button>
        </form>

        <form class="menu-item" method="get" action="/RentersList">
            <img src="~/img/side-bar/users 1.svg" alt="/RentersList" />
            <button type="submit" name="CustomersBtn">Жильцы</button>
        </form>

        <form class="menu-item" method="get" action="/Reportcshtml">
            <img src="~/img/side-bar/chart-no-axes-column 1.svg" alt="404" />
            <button type="submit" name="recordsBtn">Отчетность</button>
        </form>
    </div>

    <div id="main-content-main-page">
        <div class="top-bar">
            <form asp-page-handler="Logout" id="logoutForm">
                <a href="#" onclick="confirmLogout()">
                    <img src="~/img/userIcon.svg" alt="Фотка иконки юзера" />
                </a>
            </form>
            <a href="#"><img src="~/img/bell.svg" alt="Фотка иконки уведомлений" /></a>
            <form method="post">
                <button type="submit" class="update_btn" asp-page-handler="RefreshReservations">Обновить данные</button>
            </form>
        </div>

        @if (TempData["ReservationMessage"] != null)
        {
            <div style="background: #334155; color: #CBD5E1; padding: 10px; margin: 10px 0; border-radius: 5px;">
                @TempData["ReservationMessage"]
            </div>
        }

        <div class="calendar-container">
            <div class="calendar"
            style="
                    grid-template: repeat(1, 75px)/repeat(1,2fr);
                    height: @(Model.FlatBookingsViewModels?.Count * 100 + 30 + 30)px;
                    padding-bottom: 30px;
">
                @{
                    <div class="grid-row1" style="grid-template-columns: repeat(@(Model.DaysCount + 1), 75px);">
                        <button id="addReservationBtn" class="add-button">+</button>
                        @{
                            foreach (var item in Model.Days)
                            {
                                <span style="display: flex; justify-content: center;">@item.ToString("dd.MM")</span>
                            }
                        }
                    </div>

                    <div class="grid-column1" style="grid-template-rows: repeat(@(Model.FlatBookingsViewModels?.Count), 75px);">
                        @{
                            for (int i = 0; i < Model.FlatBookingsViewModels?.Count; i++)
                            {
                                FlatBookingsViewModel flat = Model.FlatBookingsViewModels[i];
                                <img src="@flat.PhotoBase64" style="height: 75px; width: 75px; z-index: 10; object-fit: cover" />
                            }
                        }
                    </div>
                    <div class="calendar-content" style="
                            grid-template-columns: repeat(@(Model.DaysCount), 75px);
                            grid-template-rows: 30px repeat(@(Model.FlatBookingsViewModels?.Count), 75px;
                            height: @(Model.FlatBookingsViewModels?.Count * 75)px;">
                        @{
                            for (int i = 0; i < Model.FlatBookingsViewModels?.Count; i++)
                            {
                                FlatBookingsViewModel flat = Model.FlatBookingsViewModels[i];

                                int j = 0;

                                while (j < Model.Days.Count)
                                {
                                    var reservationsForThisDay = flat.Reservations.Where(reservation =>
                                        Model.Days[j] >= reservation.DateOfStartReservation &&
                                        Model.Days[j] < reservation.DateOfEndReservation
                                    ).ToList();

                                    ReservationViewModel? reservation = reservationsForThisDay.FirstOrDefault();

                                    if (reservation != null)
                                    {
                                        DateTime startDate = reservation.DateOfStartReservation.ToDateTime(TimeOnly.MinValue);
                                        DateTime endDate = reservation.DateOfEndReservation.ToDateTime(TimeOnly.MinValue);
                                        int startOffset = (startDate.Date - Model.CalendarStart.ToDateTime(TimeOnly.MinValue).Date).Days;
                                        int endOffset = (endDate.Date - Model.CalendarStart.ToDateTime(TimeOnly.MinValue).Date).Days;

                                        int clippedStart = Math.Max(0, startOffset);
                                        int clippedEnd = Math.Min(Model.DaysCount - 1, endOffset - 1);

                                        int length = Math.Max(0, clippedEnd - clippedStart + 1);

                                        <div ondblclick="showDeleteForm(@reservation.Id)"
                                            class="calendar-flat-reservation"
                                             style="
                                                grid-column: span @length;
                                                background-color: @reservation.ColorHexCode;
                                                display: flex;
                                                align-content: center;
                                                justify-content: center;
                                                flex-direction: column">
                                            <div id="deleteForm-@reservation.Id" class="delete-form" style="display: none;">
                                                <p>Удалить бронь?</p>
                                                <form method="post" asp-page-handler="DeleteReservation">
                                                    <input type="hidden" name="reservationIdToDelete" value="@reservation.Id" />
                                                    <button type="submit" class="btn-delete">Да</button>
                                                    <button type="button" onclick="hideDeleteForm(@reservation.Id)" class="btn-cancel">Нет</button>
                                                </form>
                                            </div>
                                             <p style="color: var(--text-color); padding-left: 5px">@reservation.RenterName</p>
                                            <p style="color: var(--text-color); padding-left: 5px">@reservation.PhoneNumber</p>
                                        </div>

                                        j += length;
                                    }
                                    else
                                    {
                                        <div class="calendar-flat-item">
                                        </div>

                                        j++;
                                    }
                                }
                            }
                        }
                    </div>
                }
            </div>
        </div>
        <div id="addReservationModal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>Добавить новое бронирование</h2>
                <form id="addReservationForm" method="post" asp-page-handler="AddReservation">
                    <div class="form-group">
                        <select class="flat-select" asp-for="newReservation.RenterId" id="renterSelect" required>
                            <option value="">Выберите арендателя</option>
                        </select>
                        <span asp-validation-for="newReservation.RenterId"></span>
                    </div>
                    <div class="form-group">
                        <select class="flat-select" id="flatsSelect" name="FlatID" required>
                            <option value="">Выберите квартиру</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label asp-for="newReservation.DateOfStartReservation">Дата заезда</label>
                        <input type="date" asp-for="newReservation.DateOfStartReservation" id="date_start" required>
                        <span asp-validation-for="newReservation.DateOfStartReservation"></span>
                    </div>
                    <div class="form-group">
                        <label asp-for="newReservation.DateOfEndReservation">Дата выезда</label>
                        <input type="date" asp-for="newReservation.DateOfEndReservation" id="date_end" required>
                        <span asp-validation-for="newReservation.DateOfEndReservation"></span>
                    </div>
                    <div class="form-buttons">
                        <button type="submit" class="submit-btn">Добавить</button>
                        <button type="button" class="cancel-btn">Отмена</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>

        function confirmLogout() {
            if (confirm('Вы уверены, что хотите выйти?')) {
                document.getElementById('logoutForm').submit();
            }
        }
        const modal = document.getElementById('addReservationModal');
        const addBtn = document.getElementById('addReservationBtn');
        const closeBtn = document.querySelector('.close');
        const cancelBtn = document.querySelector('.cancel-btn');
        const form = document.querySelector('#addReservationForm')

        var renters = @Json.Serialize(Model.Renters)
        var flats = @Json.Serialize(Model.Flats)

        setupDateConstraints();
        fillRenterSelect();
        fillFlatsSelect();

        addBtn.onclick = function () {
            modal.style.display = 'block';
        }

        closeBtn.onclick = function () {
            modal.style.display = 'none';
            form.reset();
        }

        cancelBtn.onclick = function () {
            modal.style.display = 'none';
            form.reset();
        }

        window.onclick = function (event) {
            if (event.target == modal) {
                modal.style.display = 'none';
                form.reset();
            }
        }

        function fillRenterSelect() {
            const select = document.getElementById('renterSelect');
            select.innerHTML = '<option value="">Выберите арендателя</option>';

            renters.forEach(renter => {
                const option = document.createElement('option');
                option.value = renter.renterId;

                const patronymic = renter.patronymic || '';
                const fullName = `${patronymic} ${renter.name} ${renter.lastname}`.trim();

                option.textContent = fullName;
                select.appendChild(option);
            });
        }
        function fillFlatsSelect() {
            const select = document.getElementById('flatsSelect');

            flats.forEach(flat => {
                const option = document.createElement('option');
                option.value = flat.flatId;

                const fullName = `г.${flat.city} ул.${flat.district} д.${flat.apartmentNumber}`.trim();

                option.textContent = fullName;
                select.appendChild(option);
            });
        }

        function setupDateConstraints() {
            const dateStartInput = document.getElementById('date_start');
            const dateEndInput = document.getElementById('date_end');

            const today = new Date().toISOString().split('T')[0];

            dateStartInput.min = today;

            dateStartInput.addEventListener('change', function () {
                if (this.value) {
                    const startDate = new Date(this.value);
                    const minEndDate = new Date(startDate);
                    minEndDate.setDate(minEndDate.getDate() + 1); // Минимум +1 день

                    const maxEndDate = new Date(startDate);
                    maxEndDate.setFullYear(maxEndDate.getFullYear() + 1); // Максимум +1 год

                    dateEndInput.min = minEndDate.toISOString().split('T')[0];
                    dateEndInput.max = maxEndDate.toISOString().split('T')[0];
                    dateEndInput.disabled = false;

                    // Сбрасываем дату выезда если она стала невалидной
                    if (dateEndInput.value && new Date(dateEndInput.value) < minEndDate) {
                        dateEndInput.value = '';
                    }
                } else {
                    dateEndInput.disabled = true;
                    dateEndInput.value = '';
                }
            });

            // Инициализация - делаем поле даты выезда неактивным
            dateEndInput.disabled = true;
        }

        //Модальное окно брони
        function showDeleteForm(reservationId) {
            document.getElementById('deleteForm-' + reservationId).style.display = 'flex';
        }

        function hideDeleteForm(reservationId) {
            document.getElementById('deleteForm-' + reservationId).style.display = 'none';
        }
    </script>
</body>
</html>
